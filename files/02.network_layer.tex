\Section{Сетевой уровень TCP/IP}{Лекция 2}{Игорь Смирнов}

Протоколы:
\begin{itemize}
    \item IP~--- основной протокол архитектуры TCP/IP
    \item ICMP~--- протокол управляющих сообщений
    \item IGMP~--- протокол работы с группами
    \item ARP~--- протокол разрешения адресов~--- связь между собой адресов канального и сетевого уровней
    \item Протоколы маршрутизации
\end{itemize}

\Subsection{Протокол IP}

{\bf IP}~--- Internet Protocol

Стандарт RFC 791, 1981 год

Текущая действующая версия~--- 4 (IPv4)

Состоит из заголовка и тела

Суммарная длина до 64 Кбайт

Структура IP-пакета:

TODO: картинка

Ширина картинки~--- 32 разряда. Под каждым полем подписано, сколько разрядов оно занимает.

\begin{itemize}
    \item V~--- версия протокола
    \item HL~--- длина заголовка в 32-разрядных словах
    \item TOS~--- пожелания к процедуре обслуживания данного пакета
    \item Length~--- длина пакета в байтах
    \item ID~--- идентификатор (для фрагментации)
    \item F~--- флаги (для фрагментации)
    \item Offset~--- смещение (для фрагментации)
    \item TTL~--- время жизни
    \item Protocol~--- вложенный протокол (в данных)
    \item HCRC~--- контрольная сумма (по заголовку)
    \item Source Address~--- адрес отправителя
    \item Destination Address~--- адрес получателя
    \item Options~--- если пакет нестандартный и требует каких-то опций, можем их включить
    \item Pad~--- заполнитель, если опции не кратны 32 разрядам
    \item Data~--- данные
\end{itemize}

\Subsubsection{Поля заголовка пакета IP}

\begin{itemize}
    \item V~--- версия протокола (4)
    \item HL~--- длина заголовка в 32-разрядных словах (от 5 до 15). По дефолту 5, а эти 10 слов~--- на опции
    \item Length~--- длина пакета в байтах
    \item TTL~--- время жизни. Имело разный смысл. Изначально записывали значение <<время жизни пакета в секундах>> и маршрутизаторы отнимали из него время своей обработки. Сейчас это неактуально. Теперь каждый промежуточный маршрутизатор отнимает единицу. Если маршрутизатор получает 0, он удаляет пакет и посылает обратно ICMP сообщение. Время жизни нужно ограничивать, чтобы не зациклиться (мало ли где-то в сети есть петля маршрутизации). Утверждается, что между любыми узлами в сети интернет не более 29 промежуточных. То есть можно ставить 30.
    \item HCRC~--- контрольная сумма (по заголовку). Считается циклическим полиномом, по которому можно определить, не произошло ли искажения при передаче.
    \item Source Address~--- адрес отправителя
    \item Destination Address~--- адрес получателя
    \item Data~--- данные (тело пакета)
\end{itemize}

А где же записывается маска подсети? Она нужна только для процедуры маршрутизации, чтобы определить, каким путём посылать пакет. Самому пакету маски не нужны. 

\begin{itemize}
    \item Protocol~--- идентификатор вложенного протокола. Список идентификаторов лежит в RFC 1700. В операционных системах есть файл, который содержит код протокола ({\tt /etc/protocols}, {\tt \%systemroot\%$\backslash$system32$\backslash$drivers$\backslash$etc$\backslash$protocol})\\
    Основные протоколы:
    \begin{itemize}
        \item 1~--- ICMP
        \item 2~--- IGMP
        \item 4~--- IP4
        \item 6~--- TCP
        \item 17~--- UDP
        \item 89~--- OSPF
    \end{itemize}
    \item TOS~--- тип сервиса. Пожелания относительно способа доставки. В общем случае, пожелания могут быть проигнорированы. Но внутри своей сети можем запилить.\\
    TODO: картинка\\
    \begin{itemize}
        \item Приоритет (первые 3 разряда). Можно сделать очередь с приоритетом обработки пакетов (внутри своей сети).\\
        0~--- нормальный приоритет\\
        1~--- приоритетный\\
        2~--- немедленный\\
        3~--- мгновенный\\
        4~--- срочный\\
        5~--- критический\\
        6~--- межсетевое управление\\ 
        7~--- сетевое управление\\

        В жизни используются только 0, 1, 6, 7. Даже среди них 99\%~--- приоритет 0

        \item D (delay)~--- требуется минимальная задержка
        \item T (throughput)~--- требуется максимальная пропускная способность
        \item R (reliability)~--- требуется максимальная надёжность
        \item C (cost)~--- требуется минимальная стоимость
    \end{itemize}

    При этом одновременно может быть установлено 1 или 0 флагов.

    Для классических протоколов эти флаги предопределены.

    TODO: картинка.
\end{itemize}

\Subsubsection{Фрагментация пакетов} 

Напомним, что фрагментация поузловая.

\begin{itemize}
    \item Id~--- идентификатор, одинаковый у всех фрагментов. При передаче IP пакета это поле формируется псевдослучайно
    \item Offset~--- смещение фрагмента относительно начала пакета в 8-ми байтовых словах
    \item F~--- флаги
    \begin{itemize}
        \item 0~--- зарезервировано
        \item 1~--- флаг разрешения фрагментации. Если не установлен, маршрутизатор не имеет права фрагментировать данный пакет. А если она требуется, то пакет уничтожается, а обратно посылается ICMP пакет с ошибкой.
        \item 2~--- признак последнего фрагмента (внезапно, 0, если это последний фрагмент и 1 иначе)
    \end{itemize}

    Благодаря смещению правильно складываем куски в буффере, благодаря флагу последнего пакета понимаем, что все фрагменты пришли.

    На принимающей стороне есть таймер фрагментации, и если за это время все фрагменты не пришли, посылается ICMP сообщение.
\end{itemize}

\Subsubsection{Опции протокола IP}

Идёт прямо перед данными, может быть переменной длины. Может вообще не быть.

Это необязательные опции, используются только в служебных целях.

Формат опций:

TODO: картинка

\begin{itemize}
    \item Флаг копирования~--- 1, если нужно копировать опции во все фрагменты пакета. Если 0, то только в первом фрагменте
    \item Класс опции
    \begin{itemize}
        \item 0~--- управление дейтаграммами или сетью
        \item 1~--- зарезервировано
        \item 2~--- отладка сети
        \item 3~--- зарезервировано
    \end{itemize}
    \item Номер опции~--- номер внутри класса
\end{itemize}

Основные опции:

TODO: картинка
\begin{itemize}
    \item End of Option List~--- конец списка опций. Говорит, что это последняя опция в пакете. Нужна, если граница опций не совпадает с границей заголовка IP (когда есть паддинг). Занимает 1 байт.
    \item No operation~--- нет операции. Вспомогательная, для выравнивания границы опций, занимает 1 байт
    \item Stream ID~--- идентификатор потока. Например, хотим маршрутизировать видеотрафик. Всем пакетам одного потока присваивается одна метка потока. Понимаем, как маршрутизировать первый из них, а потом остальные маршрутизируем так же. Должна копироваться при фрагментации. Занимает 4 байта: 1 байт на заголовок, 1 байт на длину, 2 байта на идентификатор потока.
    \item Strict Source Route~--- строгая маршрутизация от источника (предопределённая маршрутизация). Пакет имеет право проходить только по адресам, указанным при отправке от источника и строго в указанном порядке.
    \begin{itemize}
        \item Заголовок
        \item Максимальная длина в байтах
        \item Указатель (на каком мы сейчас маршрутизаторе)~--- смещение в байтах от начала опции
        \item Список адресов.
    \end{itemize}
    Максимум можем указать 9 маршрутизаторов (так как есть ограницение на размер опций).
    \item Loose Source Route~--- нестрогая маршрутизация от источника. Содержит адреса маршрутизаторов, через которые должен пройти пакет. Формат такой же, как и раньше. Отличие в том, что мы снова обязаны пройти через все адреса, но при этом могут быть какие-то промежуточные.

    Обе эти опции использутся только для отладки.

    \item Record Route~--- запись маршрута. Используется в ping. В traceroute используется более хитрая схема.

    Есть несколько полей. Каждый маршрутизатор заполняет соответствующее ему поле своим адресом. Структура такая же как и у прошлых. Минус в том, что максимум 9 маршрутизатором сможем записать (опять из-за длины опций). Если все поля заняты, маршрутизатор просто ничего не делает.
\end{itemize}

{\bf Лирическое отступление: как работает traceroute?}

Отсылаем пакет с TTL=1, к нам обратно приходит ICMP пакет с ошибкой. Мы записываем адрес, с которого он пришёл, отправляем пакет с TTL=2 и так далее, пока не дойдём до конечного узла. Всё это время мы генерировали UDP пакет к случайному порту в старшем диапазоне. Как только он дошёл до конца, к нам пришлют ICMP пакет в котором будет сказано, что такой получатель недостижим. Так мы и поймём, что дошли до последнего узла.

Если за время посылок маршрут изменился, то мы получим неправильный маршрут в итоге.

Второй способ~--- использовать опцию Record Route. Но там максимум 9 промежуточных узлов. {\tt ping -r 9 -n 1 172.31.254.62}. Провайдер скорее всего фильтрует эту опцию, но в локальной сети использовать можно.

\Subsection{Связь с канальным уровнем}
