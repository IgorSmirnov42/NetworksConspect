\Section{Адресация в IP}{Лекции 1-2}{Игорь Смирнов}

IP-адрес: 32 разряда

Записывается в виде десятичных октетов, разделённых точкой.

Можно адресовать $2^{32}$ узлов ($\approx 4\text{ млрд.}$)

Но не все из них поддерживаются.

Поддерживаются индивидуальная, групповая и широковещательная адресации.

Адресуется конкретный сетевой интерфейс, а не узел. Поэтому если у компьютера  сетевых интерфейса, то у него должно быть $\ge 3$ сетевых адреса. Некорректно говорить про IP-адрес узла.

И одному интерфейсу может соответствовать несколько IP-адресов. Например, если один интерфейс находится сразу в нескольких сетях.

Иногда (очень редко) можно дать один адрес нескольким интерфейсам.

Адресное пространство поделено на классы:

\begin{enumerate}
    \item Класс A~--- сети большого размера
    \item Класс B~--- сети среднего размера
    \item Класс C~--- небольшие сети
    \item Класс D~--- групповые адреса
    \item Класс E~--- для эКсПеРиМеНтОв
\end{enumerate}

Как это всё было изначально:

\Subsubsection{Адреса класса A}

Формат адреса: $0nnnnnnn.hhhhhhhh.hhhhhhhh.hhhhhhhh$

$n$~--- номер сети
$h$~--- номер узла

То есть можно сделать 128 сетей (а на самом деле 126, потому что 2 зарезерврованы) по $2^{24}-2$ узлов в каждой.

Таким образом, все адреса в диапазоне $1.0.0.0-126.255.255.255$. Даже сейчас столько адресов ни одной компании не нужно. Поэтому их используют по-другому. Как именно~--- узнаем позже.

\Subsubsection{Адреса класса B}

Формат адреса: $10nnnnnn.nnnnnnnn.hhhhhhhh.hhhhhhhh$

$n$~--- номер сети
$h$~--- номер узла

$2^{14}$ сетей (тут уже нет двух зарезервированных), по $2^{16}-2$ узлов в каждой.

Диапазон адресов $128.0.0.0-191.255.255.255$

Это очень большие сети, таких размеров хватает крупнейшим корпорациям.

\Subsubsection{Адреса класса C}

Формат адреса: $110nnnnn.nnnnnnnn.nnnnnnnn.hhhhhhhh$

$n$~--- номер сети
$h$~--- номер узла

$2^{21}$ сетей, по 254 узла.

Диапазон адресов $192.0.0.0-223.255.255.255$

\Subsubsection{Адреса класса D}

Групповые адреса Internet.

Формат адреса: $1110xxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx$

$2^{28}$ адресов, диапазон: $224.0.0.0 - 239.255.255.255$

Пример использования: вещание радиостанции на групповом адресе. Поднимаем на компьютере соотвествующий IP-адрес. Тогда автоматически будет приходить нужный трафик.

К сожалению, используется редко (хотя зря).

\Subsubsection{Адреса класса E}

Зарезервированы для экспериментов

Формат адреса: $1111xxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx$

$2^{28}$ адресов

Диапазон: $240.0.0.0-254.255.255.255$

Никогда пакет, приходящий из интернета не должен иметь класс E. Такие надо фильтровать.

\Subsection{Зарезервированные адреса}

\begin{itemize}
    \item Адрес $0.0.0.0$

    Если встречаете его в таблице маршрутизации, то это <<маршрут по умолчанию>>. Если встречаете его при адресации, то это <<данная сеть>>. Второе никогда не используется.
    \item Узел данной сети

    Вместо адреса сети записываем нули.

    A: $00000000.hhhhhhhh.hhhhhhhh.hhhhhhhh$\\
    B: $10000000.00000000.hhhhhhhh.hhhhhhhh$\\
    C: $11000000.00000000.00000000.hhhhhhhh$

    Но по факту это практически нигде не реализовано.

    \item Конкретная IP-сеть ($^*$)

    Вместо адреса узла~--- нули.

    A: $0nnnnnnn.00000000.00000000.00000000$\\
    B: $10nnnnnn.nnnnnnnn.00000000.00000000$\\
    C: $110nnnnn.nnnnnnnn.nnnnnnnn.00000000$

    Адресуем целу сеть. Используется в таблицах маршрутизации, когда хотим указать одинаковый маршрут для всей сети.

    \item Все узлы данной IP-сети ($^*$)

    Вместо адреса узла~--- единицы.

    A: $0nnnnnnn.11111111.11111111.11111111$\\
    B: $10nnnnnn.nnnnnnnn.11111111.11111111$\\
    C: $110nnnnn.nnnnnnnn.nnnnnnnn.11111111$

    Широковещательный адрес. Пакет придёт ко всем узлам этой сети. 

    Но по факту для сетей класса A и класса B не используется, потому что это мечта хакера. Посылаем 1 пакет, а его получают миллионы пользователей.

    Иногда блокируется вообще весь широковещательный трафик.

\end{itemize}

По сути последние два~--- это одно и то же. Только первое используется в таблицах маршрутизации, а второе в конкретных IP-пакетах, поэтому теоретически могли бы использовать только один из них, но почему-то так не сделали.

Из-за последних двух мы делали минус два, когда считали количество узлов в сети.

\begin{itemize}
    \item Все узлы данной локальной сети: $255.255.255.255$.

    Это отличается от <<Все узлы сети>> тем, что тут мы адресуем только те узлы, что подключены к нам канальным способом. То есть это широковещательный канальный адрес. В предыдущем же~--- сетевой уровень. Предыдущий маршрутизируется, а этот нет.

    \item Петля обратной связи.

    $01111111.xxxxxxxx.xxxxxxxx.xxxxxxxx$

    $127.0.0.1$~--- принято использовать.

    Не имеет внешнего выхода. Это обращение к самому себе через весь сетевой стек. 

    127~--- это сеть класса A. Нулевой и 127 занят, поэтому сетей класса A 126.
\end{itemize}

Так было в начале. Но потом добавили ещё несколько зарезервированных адресов.

IANA зарезервировала для внутреннего использования адреса <<неанонсированной сети>>. Когда разворачиваем локальную сеть и у нас нет полученных легальным образом адресов, мы можем использовать сеть из RFC1918:

\begin{itemize}
    \item $10.0.0.0-10.255.255.255$
    \item $172.16.0.0-172.31.255.255$
    \item $192.168.0.0-192.168.255.255$
\end{itemize}

Что будет если поставим себе другой адрес? Допустим, если мы поставили себе адрес майкрософта, мы отрежем себе доступ ко всему майкрософту.

А ещё есть зарезервированные адреса в сетях класса D.

\begin{itemize}
    \item $224.0.0.1$~--- все узлы данной подсети
    \item $224.0.0.2$~--- все маршрутизаторы данной подсети
    \item $224.0.0.5$~--- все OSPF маршрутизаторы
    \item $224.0.0.6$~--- все назначенные OSPF маршрутизаторы
    \item $224.0.0.9$~--- все RIP-2 маршрутизаторы
    \item $224.0.0.10$~--- все IGRP маршрутизаторы
\end{itemize}

\Subsection{Структуризация сетей IP}

В том, что мы обсуждали ранее много недостатков. Например, то, что много адресов вообще не используются. Поэтому придумали структуризацию сетей IP.

Теперь мы будем по-другому интерпретировать разряды адреса. Если раньше у нас были $n$ и $h$, то теперь будет $n$, $s$, $h$. $s$~--- подсеть.

Маска подсети~--- это 32-х разрядный вектор флагов. Если в $i$-ом разряде маски стоит 1, то $i$-й разряд адреса содержит часть номера сети/подсети, а если 0, то часть номера узла.

Таким образом, с помощью адреса и маски, можно более гибко разделить сеть, чем с помощью адреса и класса.

Например, сеть класса C можем разделить на 2 подсети по 128 адресов с помощью маски $255.255.255.128$, на 4 подсети по 64 адреса с помощью маски $255.255.255.192$, 8 подсетей по 32 адреса с маской $255.255.255.224$ ну и так далее.

Но вот 128 подсетей по 2 адреса~--- не работает. Потому что первый и последний адрес у нас зарезервированы. Поэтому минимальная подсеть содержит 4 адреса, 2 из которых зарезервированы.

Аналогично на подсети можно делить сети классов A и B.

В одной сети можно иметь подсети разного размера (стандарт VLSM).

Но у подсетей есть проблема (с первой и последней), потому что там есть широковещательные адреса (все нолики и все единички) и непонятно, к чему их применять (ко всей сети или к подсети). Поэтому сначала вообще не использовали первую и последнюю подсети. Однако потом подумали и поняли, что такая коллизия почти никогда не встречается, потому что всегда с нулевым адресом идёт маска, а широковещательную адресацию никто не использует. В итоге почти все маршрутизаторы позволяют использовать первую и последнюю подсети.

Принято, что сначала в маске идут разряды сети/подсети, а потом~--- узла (то есть префикс из единиц, а потом все нули). То есть теперь масок может быть всего 31 (маски из всех единиц быть не может, маска с одним ноликом бессмысленна). Кстати, маска с одной единицей тоже бессмысленна.

{\bf Префикс сети}~--- число единиц в маске (полагаем, что маска удовлетворяет предыдущему требованию).

Например, для маски $255.255.255.240$ префикс сети~--- 28.

Подсеть записывается так: $195.19.212.96/27$, то есть IP-адрес первого узла, слеш и префикс. Этот адрес соответствует подсети $195.19.212.96-195.19.212.127$

Для стандартных сетей префиксы такие:
\begin{itemize}
    \item A~--- 8
    \item B~--- 16
    \item C~--- 24
\end{itemize}

\Subsubsection{Надсети}

Обратная идея: хотим объединять несколько соседних сетей.

Например, хотим объединить $195.19.212.0$ и $195.19.213.0$

Объединим в надсеть $195.19.212.0/255.255.254.0$ (префикс 23).

А теперь хотим объединить $192.168.1.0$ и $192.168.2.0$.

Тут так не получится. Можем объединить только в сеть на 1024 адреса с префиксом 22: $192.168.0.0/255.255.252.0$

\Subsubsection{Задачки}

A~--- IP-адрес узла\\
M~--- маска подсети

Адрес подсети: $Net = A\&M$\\
Широковещательный адрес: $Broad=A|(!M)$\\
Размер подсети: $K = (!M) - 1$ (минус 1, потому что первый и последний адрес зарезервированы)

\Subsection{Адресация сервисов (приложений)}

{\bf Порт}~--- уникальный номер приложения на узле, использующего конкретный транспортный протокол.

В TCP/IP порт~--- это число от 0 до 65535.

Приложение в сети идентифицируется сокетом. {\bf Сокет}~--- это IP-адрес узла, тип транспортного протокола и номер порта.

Примеры:
\begin{itemize}
    \item TCP-сокет: $195.19.212.13:80$
    \item UDP-сокет: $195.19.212.10:53$
\end{itemize}

По соглашению, диапазон портов от 0 до 1023 зарезервирован за well-known серверными службами. Остальные, непривилегированные порты, могут использоваться любыми приложениями. 